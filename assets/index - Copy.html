<!doctype html>
<html lang='en-us'>

<head>
    <title>Train</title>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <!-- Added Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- Added Moment JS -->
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>
    <!-- Added Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <!-- <script type='text/javascript' src='assets/js/database.js'></script>  -->
    <style>
    .row {
    margin: 0;
    padding: 0;
    }  

    #add-train {
    margin: 20px;
    }
    </style>
</head>

<body>
    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1 class="display-4">Train Timetable</h1>
            <p class="lead">It's never late.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="trainSchedule">
                <h2 class="title">Current Train Schedule</h2>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Train Name</th>
                            <th>Destination</th>
                            <th>Frequency(min)</th>
                            <th>Next Arrival</th>
                            <th>Minutes Away</th>
                        </tr>
                    </thead>
                    <tbody id="schedule">
                        <tr>
                            <td>Trenton Express</td>
                            <td>Trenton</td>
                            <td>25</td>
                            <td id="NextArrival"></td>
                            <td id="MinutesAway"></td>

                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <!-- <div class="card-body"> -->
            <!-- Sign-up Form (note the various input "types")-->
            <form role="form">
                <h2 class="title">
                    Search Area
                </h2>
                <div class="form-group row">
                    <label for="name-input">Train Name</label>
                    <input class="form-control" id="name-input" type="text">
                </div>
                <div class="form-group row">
                    <label for="destination-input">Destination</label>
                    <input class="form-control" id="destination-input" type="text">
                </div>
                <div class="form-group row">
                    <label for="firstTrain-input">First Train Time(HH:mm-military time)</label>
                    <input class="form-control" id="firstTrain-input" type="text">
                </div>
                <div>
                    <label for="frequency-input">Frequency(min)</label>
                    <input class="form-control" id="frequency-input" type="text">
                </div>
                <button class="btn btn-default" id="add-train" type="submit">Submit</button>
            </form>
        </div>
    </div>

    <script>
        // 1. Initialize Firebase
        var config = {
            apiKey: "AIzaSyA8yejvOax8ekWlqMLZPWvKviS9qw-gvCw",
            authDomain: "practice1-469d1.firebaseapp.com",
            databaseURL: "https://practice1-469d1.firebaseio.com",
            projectId: "practice1-469d1",
            storageBucket: "practice1-469d1.appspot.com",
            messagingSenderId: "839189276083"
        };

        firebase.initializeApp(config);


        var database = firebase.database();


        var firstTrain

        // 2. Button for adding trains
        $("#add-train").click(function () {
            event.preventDefault();

            // Grabs user input
            var trainName = $("#name-input").val().trim()
            var destination = $("#destination-input").val().trim()
            var firstTrain = $("#firstTrain-input").val().trim()
            var frequency = $("#frequency-input").val().trim()


            // Creates local "temporary" object for holding traintime data

            var trainTime = {
                name: trainName,
                destination: destination,
                firstTrain: firstTrain,
                frequency: frequency
            };

            console.log(trainTime)

            // Uploads traintime data to the database

            database.ref("train").push(trainTime)

            // Logs everything to console
            console.log("trainname: " + trainTime.name);
            console.log("destination: " + trainTime.destination);
            console.log("firstTrain: " + trainTime.firstTrain);
            console.log("frecuency: " + trainTime.frequency);

            // Clears all of the text-boxes
            $("#name-input").text("");
            $("#destination-input").text("");
            $("#firstTrain-input").text("");
            $("#frequency-input").text("")


        })





        // 3. Create Firebase event for adding train to the database and a row in the html when a user adds an entry
        database.ref("train").on("child_added", function (childsnapshot) {
            console.log("snapshot: " + childsnapshot.val())
            console.log("snapshot: " + childsnapshot.ref)
            // Store everything into a variable.     

            var name = childsnapshot.val().name;
            var destination = childsnapshot.val().destination;
            var firstTrain = childsnapshot.val().firstTrain;
            var frequency = childsnapshot.val().frequency;

            // train Info
            console.log(name)
            console.log(destination)
            console.log(firstTrain)
            console.log(frequency)

                var newRow = $("<tr>").append(
                    $("<td>").text(name),
                    $("<td>").text(destination),
                    $("<td>").text(frequency)
                )

                $(".table>tbody").append(newRow)



            // Calculate the months worked using hardcore math
            // To calculate the months worked

            function calculateNextArrival() {

                $(".table>tbody").empty()

                // First Time (pushed back 1 year to make sure it comes before current time)
                var firstTrainConvert = moment(firstTrain, "HH:mm").subtract(1, "years")


                // Current Time
                var currentTime = moment()
                console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));

                // Difference between the times
                var difTime = moment().diff(firstTrainConvert, "minutes");
                console.log("DIFFERENCE IN TIME: " + difTime);

                // Time apart (remainder)   
                var remainder = difTime % frequency;
                console.log(remainder);

                // Minute Until Train
                var minutesAway = frequency - remainder;
                console.log(minutesAway)

                // Next Train
                var nextTrain = moment().add(minutesAway, "minutes")
                console.log(nextTrain)

                var arrival = moment(nextTrain).format("HH:mm")

                // display train information to train timetable
                var newRow = $("<tr>").append(

                    $("<td>").text(arrival),
                    $("<td>").text(minutesAway)
                )

                $(".table>tbody").append(newRow)

            }

            var interval = setInterval(calculateNextArrival, 60000)

        })

        




    </script>
</body>

</html>